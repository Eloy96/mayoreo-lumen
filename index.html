<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Papelería Lumen Mayoreo. Encuentra todo para tu oficina y escuela al mejor precio.">
    <meta name="referrer" content="no-referrer" />
    <title>Papelería Lumen Mayoreo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#0056b3',
                            600: '#004494',
                            100: '#e6f0ff'
                        },
                        accent: {
                            500: '#FACC15', 
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #invoice-template { display: none; }
        
        /* Ajustes para móviles */
        .mobile-menu-enter { transform: translateX(-100%); transition: transform 0.3s ease-out; }
        .mobile-menu-enter-active { transform: translateX(0); }
        .mobile-menu-exit { transform: translateX(0); transition: transform 0.3s ease-in; }
        .mobile-menu-exit-active { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- Template Oculto para el PDF -->
    <div id="invoice-template">
        <div class="p-8 bg-white max-w-3xl mx-auto font-sans text-slate-800">
            <div class="flex justify-between items-center border-b-2 border-brand-600 pb-6 mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-brand-600 tracking-tight">LUMEN MAYOREO</h1>
                    <p class="text-sm text-slate-500">Soluciones integrales de papelería</p>
                </div>
                <div class="text-right">
                    <h2 class="text-xl font-bold text-slate-700">COMPROBANTE DE COMPRA</h2>
                    <p class="text-sm text-slate-500 mt-1">Orden #<span id="pdf-order-id" class="font-mono text-slate-900 font-bold"></span></p>
                    <p class="text-sm text-slate-500" id="pdf-date"></p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-8 mb-8">
                <div>
                    <h3 class="font-bold text-slate-700 mb-2 uppercase text-xs tracking-wider">Cliente</h3>
                    <p id="pdf-name" class="font-medium"></p>
                    <p id="pdf-email" class="text-sm text-slate-500"></p>
                </div>
                <div>
                    <h3 class="font-bold text-slate-700 mb-2 uppercase text-xs tracking-wider">Envío a</h3>
                    <p id="pdf-address" class="text-sm"></p>
                </div>
            </div>
            <table class="w-full mb-8 border-collapse">
                <thead>
                    <tr class="bg-slate-100 text-slate-600 text-sm uppercase">
                        <th class="py-3 px-4 text-left rounded-l-lg">Producto</th>
                        <th class="py-3 px-4 text-center">Cant.</th>
                        <th class="py-3 px-4 text-right">Precio Unit.</th>
                        <th class="py-3 px-4 text-right rounded-r-lg">Total</th>
                    </tr>
                </thead>
                <tbody id="pdf-items" class="text-sm"></tbody>
            </table>
            <div class="flex justify-end mb-12">
                <div class="w-64">
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-600">Subtotal:</span>
                        <span id="pdf-subtotal" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-600">Envío:</span>
                        <span class="text-green-600 font-medium">Gratis</span>
                    </div>
                    <div class="flex justify-between py-4 text-lg font-bold text-brand-600">
                        <span>Total:</span>
                        <span id="pdf-total"></span>
                    </div>
                </div>
            </div>
            <div class="text-center border-t border-slate-200 pt-8 text-sm text-slate-500">
                <p class="font-bold text-brand-600 mb-2">¡Gracias por tu preferencia!</p>
                <p>Tu pedido será entregado en un lapso de 5 a 7 días hábiles.</p>
                <p class="mt-4 text-xs">Si tienes dudas, contáctanos: ventas@lumen-mayoreo.mx | (55) 5555 5555</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURACIÓN ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCIZLtUorJsR0egSR8vYSjiwPMQ4alTNfSsu6WpeTsLEt-SUZSUVxC8Sn8YH984luGIQ/exec"; 
        const BASE_IMAGE_URL = "https://www.lumen.com.mx/"; 
        const CACHE_KEY = 'lumen_products_cache_v6'; 
        const CACHE_DURATION = 1000 * 60 * 60; 

        // --- LÓGICA DE DESCUENTOS POR MAYOREO ---
        const getWholesaleDiscount = (category, quantity, price) => {
            if (quantity >= 20) return 0.10; // 10%
            if (quantity >= 5) return 0.05;  // 5%
            return 0;
        };

        // --- ICONOS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const ShoppingCart = (p) => <IconBase {...p}><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></IconBase>;
        const MenuIcon = (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const Truck = (p) => <IconBase {...p}><rect width="16" height="13" x="4" y="5" rx="2" ry="2"/><rect width="6" height="6" x="2" y="9" rx="2" ry="2"/><path d="M18 9h2a2 2 0 0 1 2 2v2"/><path d="M2 13h2"/><path d="M22 13h-2"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const CreditCard = (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const ArrowLeft = (p) => <IconBase {...p}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const Mail = (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>;
        const FilterIcon = (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const Star = (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Package = (p) => <IconBase {...p}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const ShieldCheck = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Tag = (p) => <IconBase {...p}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></IconBase>;

        // --- DATOS DE RESPALDO ---
        const MOCK_PRODUCTS = [{ id: "PAP-001", name: "Papel Bond Carta", slug: "papel-bond", price: 95.00, category: "Papel", image: "", description: "Demo", specs: "", sku: "PAP-001" }];
        const DEFAULT_HOME_CONFIG = [{ type: 'carrusel', titulo: 'Más Vendidos', contenido: 'PAP-001' }];

        // --- HELPERS ---
        const generateSlug = (text) => !text ? 'item' : text.toString().toLowerCase().trim().replace(/[\s\W-]+/g, '-').replace(/^-+|-+$/g, '');

        // --- COMPONENTES ---
        const Button = ({ children, onClick, variant = 'primary', className = '', fullWidth = false, disabled = false }) => {
            const variants = {
                primary: "bg-brand-600 hover:bg-brand-500 text-white shadow-lg active:scale-95",
                secondary: "bg-slate-800 hover:bg-slate-700 text-white",
                outline: "border-2 border-brand-600 text-brand-600 hover:bg-brand-50",
                ghost: "bg-transparent hover:bg-slate-100 text-slate-600"
            };
            return <button className={`px-6 py-3 rounded-lg font-bold transition-all duration-150 flex items-center justify-center gap-2 ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`} onClick={onClick} disabled={disabled}>{children}</button>;
        };

        const Toast = ({ show, message }) => (
            <div className={`fixed bottom-4 right-4 left-4 md:left-auto bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3 ${show ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}`}>
                <CheckCircle className="text-green-400 shrink-0" size={24}/>
                <span className="font-medium">{message}</span>
            </div>
        );

        const ProductCarousel = ({ title, products, onProductClick, onAddToCart }) => {
            const scrollRef = useRef(null);
            const scroll = (d) => { if(scrollRef.current) scrollRef.current.scrollBy({ left: d === 'left' ? -300 : 300, behavior: 'smooth' }); };
            if (!products || products.length === 0) return null;
            return (
                <section className="py-8 md:py-12 bg-white border-b border-slate-100">
                    <div className="container mx-auto px-4 md:px-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl md:text-2xl font-bold text-slate-900 border-l-4 border-brand-600 pl-3">{title}</h2>
                            <div className="hidden md:flex gap-2">
                                <button onClick={() => scroll('left')} className="p-2 rounded-full hover:bg-slate-100"><ChevronLeft/></button>
                                <button onClick={() => scroll('right')} className="p-2 rounded-full hover:bg-slate-100"><ChevronRight/></button>
                            </div>
                        </div>
                        <div ref={scrollRef} className="flex gap-4 overflow-x-auto snap-x snap-mandatory pb-8 scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
                            {products.map(p => (
                                <div key={p.id} className="min-w-[160px] md:min-w-[260px] snap-start bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-xl transition-all cursor-pointer group flex flex-col" onClick={() => onProductClick(p)}>
                                    <div className="aspect-square relative p-4 bg-white rounded-t-xl flex items-center justify-center">
                                        <img src={p.image} className="max-w-full max-h-full object-contain" alt={p.name} onError={(e) => { e.target.src = 'https://placehold.co/300x300/f1f5f9/64748b?text=Sin+Imagen'; }} />
                                    </div>
                                    <div className="p-3 md:p-4 flex-1 flex flex-col border-t border-slate-100">
                                        <div className="text-[10px] md:text-xs text-brand-600 font-bold uppercase mb-1">{p.category}</div>
                                        <h3 className="font-bold text-sm md:text-base text-slate-800 line-clamp-2 mb-2 h-10 leading-tight">{p.name}</h3>
                                        <div className="mt-auto flex items-center justify-between">
                                            <span className="font-bold text-lg text-slate-900">${p.price.toFixed(2)}</span>
                                            <button className="bg-brand-600 text-white p-2 rounded-full hover:bg-brand-500 shadow-md" onClick={(e)=>{e.stopPropagation();onAddToCart(p)}}><ShoppingCart size={16}/></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </section>
            );
        };

        const MainBannerCarousel = ({ slides }) => {
            const [current, setCurrent] = useState(0);
            useEffect(() => {
                if (slides.length <= 1) return;
                const timer = setInterval(() => setCurrent(c => (c + 1) % slides.length), 5000);
                return () => clearInterval(timer);
            }, [slides.length]);
            if (!slides || slides.length === 0) return null;
            return (
                <div className="relative w-full bg-slate-900 overflow-hidden h-[200px] md:h-[400px]">
                    {slides.map((imgUrl, i) => (
                        <div key={i} className={`absolute inset-0 transition-opacity duration-1000 ${i === current ? 'opacity-100' : 'opacity-0'}`}>
                            <img src={imgUrl} className="w-full h-full object-cover opacity-90" onError={(e) => { e.target.style.display='none'; }} />
                        </div>
                    ))}
                    {slides.length > 1 && <div className="absolute bottom-4 left-0 right-0 flex justify-center gap-2 z-10">{slides.map((_, i) => <button key={i} onClick={()=>setCurrent(i)} className={`h-2 rounded-full transition-all ${i === current ? 'bg-brand-500 w-8' : 'bg-white/50 w-2'}`} />)}</div>}
                </div>
            );
        };

        const StaticBanner = ({ imageUrl, link, onClick }) => {
            const safeUrl = imageUrl ? imageUrl.split(',')[0].trim() : null;
            if (!safeUrl) return null;
            return (
                <div className="w-full h-[150px] md:h-[350px] overflow-hidden my-4 md:my-8 cursor-pointer" onClick={() => link && onClick(link)}>
                    <img src={safeUrl} className="w-full h-full object-cover hover:scale-105 transition-transform duration-700" onError={(e) => { e.target.style.display='none'; }}/>
                </div>
            );
        };

        const ProductDetailView = ({ product, products, addToCart, navigate, goHome, goToProductList, onProductClick }) => {
            if (!product) return null;
            const [quantity, setQuantity] = useState(1);
            useEffect(() => { setQuantity(1); }, [product.id]);

            const randomProducts = useMemo(() => products.filter(p => p.id !== product.id).sort(() => 0.5 - Math.random()).slice(0, 5), [product, products]);
            const handleQuantityChange = (delta) => setQuantity(prev => Math.max(1, prev + delta));
            
            // Calculo de mensaje de descuento
            let discountMsg = "";
            let nextDiscount = null;
            if (quantity < 5) {
                nextDiscount = { qty: 5, off: 5 };
                discountMsg = `¡Agrega ${5 - quantity} más para 5% de descuento!`;
            } else if (quantity < 20) {
                nextDiscount = { qty: 20, off: 10 };
                discountMsg = `¡Agrega ${20 - quantity} más para 10% de descuento!`;
            } else {
                discountMsg = "¡Felicidades! Tienes precio de Mayorista (10%)";
            }

            const discountPercent = getWholesaleDiscount(product.category, quantity, product.price);
            const discountedPrice = product.price * (1 - discountPercent);

            return (
                <div className="container mx-auto px-4 md:px-6 py-6 min-h-screen animate-fade-in">
                    <nav className="flex text-sm text-slate-500 mb-6 gap-2 items-center overflow-x-auto whitespace-nowrap">
                        <span onClick={goHome} className="cursor-pointer hover:text-brand-600">Inicio</span> <ChevronRight size={14}/>
                        <span onClick={()=>goToProductList(product.category)} className="cursor-pointer hover:text-brand-600">{product.category}</span> <ChevronRight size={14}/>
                        <span className="font-bold text-slate-900 truncate">{product.name}</span>
                    </nav>

                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden mb-12">
                        <div className="flex flex-col lg:flex-row">
                            <div className="lg:w-1/2 p-6 md:p-10 bg-white flex items-center justify-center border-b lg:border-b-0 lg:border-r border-slate-100">
                                <img src={product.image} className="max-w-full max-h-[300px] md:max-h-[500px] object-contain"/>
                            </div>
                            <div className="lg:w-1/2 p-6 md:p-10 flex flex-col">
                                <span className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide w-fit mb-4">{product.category}</span>
                                <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 mb-2">{product.name}</h1>
                                <div className="text-sm text-slate-400 mb-6 font-mono">SKU: {product.sku}</div>
                                
                                <div className="mb-6">
                                    {discountPercent > 0 ? (
                                        <div>
                                            <div className="flex items-center gap-3 flex-wrap">
                                                <span className="text-3xl md:text-4xl font-bold text-brand-600">${discountedPrice.toFixed(2)}</span>
                                                <span className="text-lg text-slate-400 line-through">${product.price.toFixed(2)}</span>
                                                <span className="bg-green-100 text-green-700 px-2 py-1 rounded-md text-xs font-bold border border-green-200">-{ (discountPercent * 100).toFixed(0) }% OFF</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-3xl md:text-4xl font-bold text-brand-600">${product.price.toFixed(2)}</div>
                                    )}
                                </div>

                                {/* Barra de Progreso de Mayoreo */}
                                <div className="bg-brand-50 border border-brand-100 rounded-lg p-3 mb-6">
                                    <div className="flex items-center gap-2 text-brand-700 text-sm font-bold mb-2">
                                        <Tag size={16}/> {discountMsg}
                                    </div>
                                    {/* Visual bar simple */}
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div className="bg-brand-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${Math.min(100, (quantity / 20) * 100)}%` }}></div>
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>1 pza</span>
                                        <span>5 pzas (5%)</span>
                                        <span>20 pzas (10%)</span>
                                    </div>
                                </div>
                                
                                <div className="mt-auto flex flex-col gap-4">
                                    <div className="flex items-center justify-between bg-white border border-slate-300 rounded-xl p-1 shadow-sm">
                                        <button onClick={() => handleQuantityChange(-1)} className="w-12 h-12 flex items-center justify-center hover:bg-slate-100 rounded-lg text-slate-600 transition-colors text-xl font-bold">-</button>
                                        <span className="flex-1 text-center font-bold text-slate-900 text-xl">{quantity}</span>
                                        <button onClick={() => handleQuantityChange(1)} className="w-12 h-12 flex items-center justify-center hover:bg-slate-100 rounded-lg text-slate-600 transition-colors text-xl font-bold">+</button>
                                    </div>
                                    <Button fullWidth className="text-lg py-4 shadow-xl" onClick={()=>{addToCart(product, quantity); navigate('/carrito')}}>Agregar al Carrito</Button>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 md:p-10 bg-slate-50 border-t border-slate-100">
                            <h3 className="text-xl font-bold text-slate-900 mb-4">Descripción</h3>
                            <div className="prose max-w-none text-slate-600 text-sm md:text-base">
                                <p className="mb-4 font-medium">{product.description}</p>
                                <p className="leading-relaxed whitespace-pre-line">{product.longDescription || product.description}</p>
                            </div>
                        </div>
                    </div>
                    <ProductCarousel title="Por si se te olvidó" products={randomProducts} onProductClick={onProductClick} onAddToCart={addToCart} />
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [view, setView] = useState('home');
            const [loading, setLoading] = useState(true);
            const [connectionError, setConnectionError] = useState(false);
            const [products, setProducts] = useState([]);
            const [homeConfig, setHomeConfig] = useState([]);
            const [categories, setCategories] = useState([]);
            const [cart, setCart] = useState([]);
            const [lastOrder, setLastOrder] = useState(null);
            const [activeCategory, setActiveCategory] = useState(null); 
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [currentBanner, setCurrentBanner] = useState(0);
            const [priceRange, setPriceRange] = useState({ min: '', max: '' });
            const [activePriceFilter, setActivePriceFilter] = useState({ min: 0, max: 999999 });
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [shippingData, setShippingData] = useState({ name: '', email: '', address: '', city: '', cp: '' });
            const [isProcessing, setIsProcessing] = useState(false);
            const [orderId, setOrderId] = useState('');
            const [cardNum, setCardNum] = useState('');
            const [cardDate, setCardDate] = useState('');
            const [cardCvv, setCardCvv] = useState('');
            const [toastMessage, setToastMessage] = useState('');
            const [showToast, setShowToast] = useState(false);

            const showNotification = (msg) => { setToastMessage(msg); setShowToast(true); setTimeout(() => setShowToast(false), 3000); };

            const submitOrderToSheets = async (orderData) => {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
                    return true;
                } catch (error) { console.error(error); return false; }
            };

            useEffect(() => {
                const delayDebounceFn = setTimeout(() => {
                    if (searchTerm.trim().length > 0) {
                        const results = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 10);
                        setSearchResults(results);
                    } else setSearchResults([]);
                }, 500); 
                return () => clearTimeout(delayDebounceFn);
            }, [searchTerm, products]);

            const handleSearchChange = (e) => setSearchTerm(e.target.value);

            useEffect(() => {
                const loadData = async (retryCount = 0) => {
                    setLoading(true);
                    let loadedProducts = [];
                    let loadedHomeConfig = [];
                    const cachedData = localStorage.getItem(CACHE_KEY);
                    if (cachedData) {
                        try {
                            const { timestamp, data } = JSON.parse(cachedData);
                            if (Date.now() - timestamp < CACHE_DURATION) {
                                setProducts(data); processCategories(data); setLoading(false); return;
                            }
                        } catch (e) { localStorage.removeItem(CACHE_KEY); }
                    }
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL);
                        if (!response.ok) throw new Error("Error HTTP");
                        const data = await response.json();
                        const rawProducts = data.products || (Array.isArray(data) ? data : []);
                        const rawConfig = data.homeConfig || [];
                        loadedProducts = rawProducts.map(item => {
                            const newItem = {};
                            Object.keys(item).forEach(k => {
                                const val = item[k];
                                const lowK = k.toLowerCase().trim();
                                if (['sku', 'id'].includes(lowK)) newItem.id = val;
                                if (lowK === 'sku') newItem.sku = String(val);
                                if (['name', 'nombre', 'producto'].includes(lowK)) newItem.name = val;
                                if (['price', 'precio'].includes(lowK)) newItem.price = parseFloat(String(val).replace(/[^0-9.]/g, '')) || 0;
                                if (['category', 'categoria', 'categoría'].includes(lowK)) newItem.category = val;
                                if (['image', 'imagen', 'img', 'url'].includes(lowK)) {
                                    let imgUrl = String(val).trim();
                                    if (imgUrl.includes('drive.google.com') && imgUrl.includes('/file/d/')) { const idMatch = imgUrl.match(/\/d\/(.+?)\//); if (idMatch) imgUrl = `https://drive.google.com/uc?id=${idMatch[1]}`; } else if (imgUrl && !imgUrl.startsWith('http')) imgUrl = BASE_IMAGE_URL + (imgUrl.startsWith('/') ? imgUrl.substring(1) : imgUrl);
                                    newItem.image = imgUrl;
                                }
                                if (['description', 'descripcion', 'descripción'].includes(lowK)) newItem.description = val;
                                if (['longdescription', 'descripcionlarga', 'detalle'].includes(lowK)) newItem.longDescription = val;
                                if (['specs', 'especificaciones'].includes(lowK)) newItem.specs = typeof val === 'string' ? val.split('|').map(s=>s.trim()) : [];
                                if (['metatitle', 'meta_title'].includes(lowK)) newItem.metaTitle = val;
                                if (['metadescription', 'meta_desc'].includes(lowK)) newItem.metaDescription = val;
                                if (['canonical', 'canonico', 'url_canonica'].includes(lowK)) newItem.canonical = val;
                            });
                            if (!newItem.id) newItem.id = Math.random().toString(36).substr(2, 9);
                            if (!newItem.sku) newItem.sku = newItem.id;
                            if (!newItem.name) newItem.name = "Producto sin nombre";
                            if (!newItem.category) newItem.category = "General";
                            return newItem;
                        }).filter(p => p.name !== "Producto sin nombre").map(p => ({ ...p, slug: generateSlug(p.name) }));

                        loadedHomeConfig = rawConfig.map(section => {
                            if (section.contenido && section.contenido.includes('drive.google.com') && section.contenido.includes('/file/d/')) {
                                const urls = section.contenido.split(',').map(url => { const idMatch = url.trim().match(/\/d\/(.+?)\//); return idMatch ? `https://drive.google.com/uc?id=${idMatch[1]}` : url.trim(); });
                                section.contenido = urls.join(',');
                            }
                            return section;
                        });
                        setConnectionError(false);
                    } catch (error) {
                        console.error("Fallo carga remota", error);
                        if (retryCount < 2) { setTimeout(() => loadData(retryCount + 1), 1500); return; }
                        setConnectionError(true);
                    }
                    if (loadedProducts.length === 0) { loadedProducts = MOCK_PRODUCTS; loadedHomeConfig = DEFAULT_HOME_CONFIG; }
                    setProducts(loadedProducts); setHomeConfig(loadedHomeConfig);
                    const cats = [...new Set(loadedProducts.map(p => p.category))].filter(Boolean).map(c => ({ id: c, name: c, slug: generateSlug(c) }));
                    setCategories(cats); setLoading(false);
                };
                loadData();
            }, []);

            const processCategories = (prods) => { const cats = [...new Set(prods.map(p => p.category))].filter(Boolean).map(c => ({ id: c, name: c, slug: generateSlug(c) })); setCategories(cats); };

            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash;
                    if (!hash || hash === '#/') { setView('home'); setActiveCategory(null); }
                    else if (hash === '#/categorias') setView('categories');
                    else if (hash.includes('/producto/')) {
                        const parts = hash.split('/'); const prodSlug = parts[parts.length - 1];
                        if (products.length > 0) { const product = products.find(p => p.slug === prodSlug); if (product) { setSelectedProduct(product); setView('product-detail'); } }
                    } else if (hash.startsWith('#/categoria/')) {
                        const slug = hash.replace('#/categoria/', '');
                        if (categories.length > 0) { const cat = categories.find(c => c.slug === slug); if(cat) setActiveCategory(cat.name); else setActiveCategory(slug.replace(/-/g, ' ')); }
                        setView('product-list');
                    } else if (hash === '#/carrito') setView('cart');
                    else if (hash === '#/checkout/envio') setView('checkout-shipping');
                    else if (hash === '#/checkout/pago') setView('checkout-payment');
                    else if (hash === '#/confirmacion') setView('success');
                    window.scrollTo(0, 0);
                };
                window.addEventListener('hashchange', handleHashChange);
                if (!loading && products.length > 0) handleHashChange();
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, [products, categories, loading]);

            const navigate = (path) => { window.location.hash = path; };
            const goHome = () => navigate('/');
            const goToCategories = () => { setIsMenuOpen(false); navigate('/categorias'); };
            const goToProductList = (catName) => { const cat = categories.find(c => c.name === catName); if(cat) navigate(`/categoria/${cat.slug}`); else navigate(`/categoria/${generateSlug(catName)}`); };
            const goToProductDetail = (p) => { const catSlug = p.category ? generateSlug(p.category) : 'general'; navigate(`/categoria/${catSlug}/producto/${p.slug}`); };

            const addToCart = (p, qty=1) => {
                setCart(prev => {
                    const ex = prev.find(i => i.id === p.id);
                    return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity + qty} : i) : [...prev, {...p, quantity: qty}];
                });
                showNotification(`Agregado: ${p.name}`);
            };
            const updateQty = (id, d) => setCart(prev => prev.map(i => i.id === id ? {...i, quantity: Math.max(1, i.quantity + d)} : i));
            const remove = (id) => setCart(prev => prev.filter(i => i.id !== id));
            
            const cartTotals = useMemo(() => {
                let subtotal = 0; let totalDiscount = 0; let finalTotal = 0;
                cart.forEach(item => {
                    const discountPercent = getWholesaleDiscount(item.category, item.quantity, item.price);
                    const itemTotalRaw = item.price * item.quantity;
                    const discountAmount = itemTotalRaw * discountPercent;
                    subtotal += itemTotalRaw; totalDiscount += discountAmount; finalTotal += (itemTotalRaw - discountAmount);
                });
                return { subtotal, totalDiscount, finalTotal };
            }, [cart]);

            const applyPriceFilter = () => { const min = priceRange.min ? parseFloat(priceRange.min) : 0; const max = priceRange.max ? parseFloat(priceRange.max) : 999999; setActivePriceFilter({ min, max }); };
            const getFilteredProducts = () => {
                let filtered = products;
                if (activeCategory) filtered = filtered.filter(p => p.category && p.category.toLowerCase().includes(activeCategory.toLowerCase().replace(/-/g, ' ')));
                filtered = filtered.filter(p => p.price >= activePriceFilter.min && p.price <= activePriceFilter.max);
                return filtered;
            };

            const handleCardChange = (e) => setCardNum(e.target.value.replace(/\D/g, '').slice(0, 16));
            const handleDateChange = (e) => { let v = e.target.value.replace(/\D/g, '').slice(0, 4); if (v.length >= 2) v = v.slice(0, 2) + '/' + v.slice(2); setCardDate(v); }
            const handleDownloadPDF = () => { if (!lastOrder) return; document.getElementById('pdf-order-id').innerText = orderId; document.getElementById('pdf-date').innerText = new Date().toLocaleDateString(); document.getElementById('pdf-name').innerText = shippingData.name; document.getElementById('pdf-email').innerText = shippingData.email; document.getElementById('pdf-address').innerText = shippingData.address + ', ' + shippingData.city + ', CP: ' + shippingData.cp; document.getElementById('pdf-subtotal').innerText = '$' + lastOrder.subtotal.toFixed(2); document.getElementById('pdf-discount').innerText = '-$' + lastOrder.totalDiscount.toFixed(2); document.getElementById('pdf-total').innerText = '$' + lastOrder.finalTotal.toFixed(2); const itemsContainer = document.getElementById('pdf-items'); itemsContainer.innerHTML = ''; lastOrder.items.forEach((item, index) => { const discountPercent = getWholesaleDiscount(item.category, item.quantity, item.price); const itemTotal = (item.price * item.quantity) * (1 - discountPercent); const row = `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'} border-b border-slate-100"><td class="py-3 px-4">${item.name}</td><td class="py-3 px-4 text-center">${item.quantity}</td><td class="py-3 px-4 text-right">$${item.price.toFixed(2)}</td><td class="py-3 px-4 text-right text-green-600">${(discountPercent * 100).toFixed(0)}%</td><td class="py-3 px-4 text-right font-bold">$${itemTotal.toFixed(2)}</td></tr>`; itemsContainer.innerHTML += row; }); const element = document.getElementById('invoice-template'); element.style.display = 'block'; const opt = { margin: 0, filename: `Comprobante_Lumen_${orderId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save().then(() => { element.style.display = 'none'; }); };
            const handleResendEmail = async () => { if (shippingData.email && lastOrder) { const orderPayload = { action: 'resend_email', orderId: orderId, shipping: shippingData, items: lastOrder.items, total: lastOrder.total }; await submitOrderToSheets(orderPayload); showNotification("Intentando reenviar correo..."); } };
            const getProductsBySkus = (skuString) => { if (!skuString) return []; const skus = skuString.toString().split(',').map(s => s.trim().toLowerCase().replace(/^sku-/, '')); return products.filter(p => { if (!p.sku) return false; const pSku = String(p.sku).toLowerCase().replace(/^sku-/, ''); return skus.includes(pSku); }); };
            const onProductClick = (p) => { const catSlug = p.category ? generateSlug(p.category) : 'general'; navigate(`/categoria/${catSlug}/producto/${p.slug}`); };

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-500"><div className="w-16 h-16 border-4 border-brand-600 border-t-transparent rounded-full animate-spin mb-4"></div><p className="font-bold text-lg animate-pulse">Cargando catálogo Lumen...</p></div>;

            const renderDynamicHome = () => {
                const layout = (homeConfig && homeConfig.length > 0) ? homeConfig : DEFAULT_HOME_CONFIG;
                return (
                    <div className="animate-fade-in pb-20">
                        {connectionError && <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 flex items-center justify-between"><div className="flex items-center"><AlertTriangle className="mr-2" size={24} /><div><p className="font-bold">Modo Sin Conexión</p><p className="text-sm">Viendo datos demo.</p></div></div></div>}
                        {layout.map((section, idx) => {
                            let type = (section.tipo || section.type || '').toLowerCase().trim();
                            const title = section.titulo || section.title;
                            const content = section.contenido || section.content;
                            const link = section.link;
                            if (type === 'banner') type = 'banner_principal';
                            if (type === 'simple' || type === 'imagen') type = 'banner_simple';
                            if (type === 'banner_principal') { const slides = content ? content.split(',').map(s => { let url = s.trim(); const idMatch = url.match(/\/d\/(.+?)\//) || url.match(/[?&]id=([^&]+)/); if (url.includes('drive.google.com') && idMatch) { return `https://lh3.googleusercontent.com/d/${idMatch[1]}`; } return url; }) : []; return <MainBannerCarousel key={idx} slides={slides} />; }
                            if (type === 'banner_simple') { let safeUrl = content ? content.split(',')[0].trim() : null; if (safeUrl && safeUrl.includes('drive.google.com')) { const idMatch = safeUrl.match(/\/d\/(.+?)\//) || safeUrl.match(/[?&]id=([^&]+)/); if (idMatch) safeUrl = `https://lh3.googleusercontent.com/d/${idMatch[1]}`; } return <StaticBanner key={idx} imageUrl={safeUrl} link={link} onClick={() => link && (link.startsWith('/') ? navigate(link) : window.location.href = link)} />; }
                            if (type === 'carrusel') { const carouselProducts = getProductsBySkus(content); if (carouselProducts.length === 0) { console.warn(`Carrusel "${title}" oculto`); return null; } return <ProductCarousel key={idx} title={title} products={carouselProducts} onProductClick={onProductClick} onAddToCart={addToCart} />; }
                            return null;
                        })}
                    </div>
                );
            };

            const renderCart = () => (
                <div className="container mx-auto px-4 md:px-6 py-8 md:py-12 max-w-5xl animate-fade-in min-h-screen">
                    <h2 className="text-2xl md:text-3xl font-bold mb-8 text-slate-800 flex items-center gap-3"><ShoppingCart size={28} className="text-brand-600"/> Tu Carrito</h2>
                    {cart.length === 0 ? <div className="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-300"><ShoppingCart size={64} className="mx-auto text-slate-300 mb-6" /><p className="text-slate-500 text-xl mb-8">Tu carrito está vacío</p><Button className="px-8 py-4 text-lg" onClick={goHome}>Ir a Comprar</Button></div> : 
                        <div className="flex flex-col lg:flex-row gap-8 lg:gap-12">
                            <div className="flex-1 space-y-6">
                                {cart.map(i => {
                                    const discountPercent = getWholesaleDiscount(i.category, i.quantity, i.price);
                                    return (
                                        <div key={i.id} className="flex flex-col sm:flex-row items-center gap-4 sm:gap-6 bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="w-24 h-24 sm:w-32 sm:h-32 bg-slate-50 rounded-xl flex items-center justify-center p-2 border border-slate-100 shrink-0"><img src={i.image} className="w-full h-full object-contain" alt={i.name} /></div>
                                            <div className="flex-1 text-center sm:text-left w-full">
                                                <h3 className="font-bold text-base sm:text-lg text-slate-900 mb-1 leading-tight">{i.name}</h3>
                                                <p className="text-xs text-slate-500 mb-2">SKU: {i.sku}</p>
                                                {discountPercent > 0 ? (
                                                    <div><div className="flex items-center gap-2 justify-center sm:justify-start"><p className="text-xs text-slate-400 line-through">${i.price.toFixed(2)}</p><p className="text-[10px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded-full">-{ (discountPercent * 100).toFixed(0) }%</p></div><p className="text-lg sm:text-2xl font-bold text-brand-600">${(i.price * (1 - discountPercent)).toFixed(2)} <span className="text-xs font-normal text-slate-500">/u</span></p></div>
                                                ) : (
                                                    <div><p className="text-lg sm:text-2xl font-bold text-brand-600">${i.price.toFixed(2)}</p><p className="text-xs text-brand-600 mt-1 font-medium bg-blue-50 px-2 py-1 rounded inline-block cursor-pointer" onClick={() => updateQty(i.id, 5 - i.quantity)}>¡Agrega {Math.max(0, 5-i.quantity)} más para descuento!</p></div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end border-t sm:border-0 pt-4 sm:pt-0 border-slate-100">
                                                <div className="flex items-center bg-slate-100 rounded-lg h-10 md:h-12 border border-slate-200">
                                                    <button onClick={()=>updateQty(i.id,-1)} className="w-10 h-full flex items-center justify-center hover:bg-slate-200 rounded-l-lg text-lg font-bold text-slate-600">-</button>
                                                    <span className="w-10 text-center font-bold text-slate-800">{i.quantity}</span>
                                                    <button onClick={()=>updateQty(i.id,1)} className="w-10 h-full flex items-center justify-center hover:bg-slate-200 rounded-r-lg text-lg font-bold text-slate-600">+</button>
                                                </div>
                                                <button onClick={()=>remove(i.id)} className="p-3 text-slate-400 hover:text-red-500 bg-white border border-slate-200 rounded-full shadow-sm"><X size={20}/></button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="lg:w-96 shrink-0">
                                <div className="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-100 sticky top-28">
                                    <h3 className="font-bold text-xl text-slate-900 mb-6 pb-4 border-b border-slate-100">Resumen del Pedido</h3>
                                    <div className="space-y-3 text-slate-600 mb-6 text-sm">
                                        <div className="flex justify-between"><span>Subtotal</span><span>${cartTotals.subtotal.toFixed(2)}</span></div>
                                        {cartTotals.totalDiscount > 0 && <div className="flex justify-between text-green-600 font-medium"><span>Ahorro por Mayoreo</span><span>-${cartTotals.totalDiscount.toFixed(2)}</span></div>}
                                        <div className="flex justify-between"><span>Envío</span><span className="text-green-600 font-medium">Gratis</span></div>
                                    </div>
                                    <div className="flex justify-between items-center mb-8 pt-4 border-t border-slate-100"><span className="font-bold text-lg text-slate-800">Total</span><span className="font-extrabold text-3xl text-brand-600">${cartTotals.finalTotal.toFixed(2)}</span></div>
                                    <Button fullWidth className="py-4 text-lg shadow-brand-500/50" onClick={()=>navigate('/checkout/envio')}>Proceder al Pago <ArrowRight className="ml-2" /></Button>
                                    <Button fullWidth variant="outline" className="mt-4" onClick={goHome}>Seguir Comprando</Button>
                                    <div className="mt-6 flex items-center justify-center gap-2 text-xs text-slate-400 bg-slate-50 p-2 rounded-lg"><ShieldCheck size={14}/> Transacción segura</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            );

            // ... (Resto de los renders: CheckoutShipping, Payment, Success, CategoriesView - Igual que antes)
            const renderCheckoutShipping = () => (
                <div className="container mx-auto px-6 py-12 max-w-xl animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6">Datos de Envío</h2>
                    <form onSubmit={(e)=>{e.preventDefault(); navigate('/checkout/pago')}} className="space-y-4 bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                        <input required placeholder="Nombre Completo" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" value={shippingData.name} onChange={e=>setShippingData({...shippingData, name: e.target.value})}/>
                        <input required placeholder="Correo Electrónico" type="email" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" value={shippingData.email} onChange={e=>setShippingData({...shippingData, email: e.target.value})}/>
                        <input required placeholder="Dirección de Entrega" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" value={shippingData.address} onChange={e=>setShippingData({...shippingData, address: e.target.value})}/>
                        <div className="flex gap-4">
                            <input required placeholder="Ciudad" className="w-full p-3 border rounded-lg outline-none" value={shippingData.city} onChange={e=>setShippingData({...shippingData, city: e.target.value})}/>
                            <input required placeholder="CP" className="w-full p-3 border rounded-lg outline-none" value={shippingData.cp} onChange={e=>setShippingData({...shippingData, cp: e.target.value})}/>
                        </div>
                        <Button type="submit" fullWidth>Continuar al Pago</Button>
                    </form>
                </div>
            );

            const renderCheckoutPayment = () => (
                <div className="container mx-auto px-6 py-12 max-w-xl animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6">Método de Pago</h2>
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                        <div className="mb-6 p-4 bg-blue-50 text-blue-800 rounded-lg text-sm flex justify-between items-center"><span>Total a cobrar:</span> <span className="font-bold text-lg">${cartTotals.finalTotal.toFixed(2)}</span></div>
                        <form onSubmit={async (e)=>{
                            e.preventDefault(); 
                            setIsProcessing(true); 
                            const randomId = 'LUM-' + Math.floor(1000 + Math.random() * 9000);
                            setOrderId(randomId);
                            setLastOrder({ items: [...cart], total: cartTotals.finalTotal, subtotal: cartTotals.subtotal, totalDiscount: cartTotals.totalDiscount });
                            
                            const orderPayload = { orderId: randomId, shipping: shippingData, items: cart, total: cartTotals.finalTotal };
                            await submitOrderToSheets(orderPayload);

                            setTimeout(()=>{ setIsProcessing(false); setCart([]); navigate('/confirmacion') }, 2000)
                        }} className="space-y-4">
                            <div className="relative"><CreditCard className="absolute left-3 top-3.5 text-slate-400"/><input required placeholder="0000 0000 0000 0000" className="w-full pl-10 p-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" maxLength="19" value={cardNum} onChange={handleCardChange}/></div>
                            <div className="flex gap-4">
                                <input required placeholder="MM/AA" className="w-full p-3 border rounded-lg outline-none text-center" maxLength="5" value={cardDate} onChange={handleDateChange}/>
                                <input required placeholder="CVV" type="password" maxLength="4" className="w-full p-3 border rounded-lg outline-none text-center" value={cardCvv} onChange={(e) => setCardCvv(e.target.value.replace(/\D/g, '').slice(0, 4))}/>
                            </div>
                            <Button type="submit" fullWidth disabled={isProcessing}>{isProcessing ? 'Procesando...' : 'Finalizar Compra'}</Button>
                        </form>
                    </div>
                </div>
            );

            const renderSuccess = () => (
                <div className="container mx-auto px-6 py-20 text-center animate-fade-in">
                    <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600"><CheckCircle size={48}/></div>
                    <h2 className="text-3xl font-extrabold text-slate-900 mb-2">¡Pedido Confirmado!</h2>
                    <p className="text-slate-500 mb-8 max-w-md mx-auto">Gracias por tu compra. Guarda tu número de pedido.</p>
                    <div className="bg-white max-w-lg mx-auto p-6 rounded-xl border border-slate-200 shadow-sm mb-8 mt-6 text-left">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                            <div><p className="text-sm text-slate-500">Número de Pedido</p><p className="text-xl font-mono font-bold text-brand-600">{orderId || 'LUM-8842'}</p></div>
                            <div className="text-right"><p className="text-sm text-slate-500">Total</p><p className="text-xl font-bold text-slate-900">${lastOrder ? lastOrder.total.toFixed(2) : '0.00'}</p></div>
                        </div>
                        <div className="space-y-3 mb-6 max-h-60 overflow-y-auto">
                            {lastOrder && lastOrder.items.map((item, idx) => {
                                const discountPercent = getWholesaleDiscount(item.category, item.quantity, item.price);
                                return (
                                    <div key={idx} className="flex gap-4 text-sm">
                                        <div className="w-12 h-12 bg-slate-50 rounded flex-shrink-0 flex items-center justify-center border border-slate-100"><img src={item.image} className="w-full h-full object-contain"/></div>
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800 line-clamp-1">{item.name}</p>
                                            <p className="text-slate-500">
                                                {item.quantity} x ${item.price.toFixed(2)} 
                                                {discountPercent > 0 && <span className="text-green-600 ml-1 text-xs">(-{(discountPercent*100).toFixed(0)}%)</span>}
                                            </p>
                                        </div>
                                        <div className="font-bold text-slate-900">${(item.quantity * item.price * (1 - discountPercent)).toFixed(2)}</div>
                                    </div>
                                );
                            })}
                        </div>
                        {lastOrder && lastOrder.totalDiscount > 0 && (
                            <div className="text-sm text-green-700 bg-green-50 p-2 rounded text-center mb-4 font-bold">
                                ¡Ahorraste ${lastOrder.totalDiscount.toFixed(2)} en este pedido!
                            </div>
                        )}
                        <div className="border-t border-slate-100 pt-4 flex flex-col gap-2 text-sm bg-slate-50 -mx-6 -mb-6 p-4 mt-4 rounded-b-xl">
                            <div className="flex justify-between items-center"><div className="flex items-center gap-2 text-green-700"><Truck size={16}/><span className="font-medium">Entrega estimada:</span></div><span className="text-slate-800 font-bold">5 a 7 días hábiles</span></div>
                        </div>
                    </div>
                    <div className="flex flex-col gap-4 max-w-lg mx-auto">
                        <Button onClick={handleDownloadPDF} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700"><Download size={20}/> Descargar Comprobante (PDF)</Button>
                        <Button onClick={handleResendEmail} className="w-full flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-500 text-white"><Mail size={20}/> Reenviar Correo</Button>
                        <Button onClick={goHome} variant="outline" className="w-full">Volver a la Tienda</Button>
                    </div>
                </div>
            );

            const renderCategoriesView = () => (
                <div className="container mx-auto px-6 py-12 animate-fade-in">
                    <h1 className="text-3xl font-bold mb-8">Nuestras Categorías</h1>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {categories.map(c => (
                            <div key={c.id} onClick={()=>goToProductList(c.name)} className="bg-white p-8 rounded-xl shadow-sm border border-slate-200 hover:border-brand-500 hover:shadow-md cursor-pointer transition-all group">
                                <h3 className="text-xl font-bold text-slate-800 group-hover:text-brand-600">{c.name}</h3>
                                <p className="text-slate-400 text-sm mt-2">Ver productos <ArrowRight size={14} className="inline ml-1"/></p>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen bg-slate-50 font-sans text-slate-800">
                    <Toast show={showToast} message={toastMessage} />
                    <header className="sticky top-0 z-50 bg-brand-600 text-white shadow-xl">
                        <div className="container mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between gap-4">
                            <div className="md:hidden">
                                <button onClick={() => setIsMenuOpen(true)} className="text-white p-1"><MenuIcon size={24} /></button>
                            </div>
                            
                            <div onClick={goHome} className="flex items-center gap-2 cursor-pointer flex-shrink-0">
                                <div className="bg-white/10 p-1.5 md:p-2 rounded-lg backdrop-blur-sm"><Package size={20} className="md:w-6 md:h-6"/></div>
                                <div className="leading-tight">
                                    <span className="block font-bold text-base md:text-lg">LUMEN</span>
                                    <span className="block text-[10px] md:text-xs text-brand-100 font-medium tracking-widest">MAYOREO</span>
                                </div>
                            </div>
                            
                            <div className="hidden md:block flex-1 max-w-2xl relative">
                                <input type="text" placeholder="Buscar productos..." className="w-full pl-4 pr-10 py-2.5 rounded-full text-slate-900 bg-white shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-300" value={searchTerm} onChange={handleSearchChange}/>
                                {searchTerm && <button onClick={()=>{setSearchTerm('');setSearchResults([])}} className="absolute right-10 top-3 text-slate-400 hover:text-slate-600"><X size={16}/></button>}
                                <Search className="absolute right-3 top-3 text-slate-400" size={18}/>
                                {searchResults.length > 0 && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 max-h-80 overflow-y-auto">
                                        {searchResults.map(p => (
                                            <div key={p.id} onClick={()=>{goToProductDetail(p); setSearchTerm(''); setSearchResults([])}} className="flex items-center gap-4 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0">
                                                <img src={p.image} className="w-10 h-10 object-contain"/>
                                                <div><div className="font-bold text-sm text-slate-900">{p.name}</div><div className="text-xs text-brand-600 font-bold">${p.price.toFixed(2)}</div></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="flex items-center gap-4 flex-shrink-0">
                                <button onClick={goToCategories} className="hidden md:flex items-center gap-2 font-bold hover:text-brand-100 transition-colors"><MenuIcon size={20}/> Categorías</button>
                                <div onClick={()=>navigate('/carrito')} className="relative cursor-pointer hover:text-brand-100 transition-colors">
                                    <ShoppingCart size={24} className="md:w-7 md:h-7"/>
                                    {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-accent-500 text-slate-900 font-bold text-[10px] md:text-xs w-4 h-4 md:w-5 md:h-5 flex items-center justify-center rounded-full shadow-sm">{cart.reduce((a,c)=>a+c.quantity,0)}</span>}
                                </div>
                            </div>
                        </div>
                        
                        {/* Mobile Search Bar (Below Header) */}
                        <div className="md:hidden px-4 pb-3">
                            <div className="relative w-full">
                                <input type="text" placeholder="Buscar..." className="w-full pl-4 pr-10 py-2 rounded-full text-slate-900 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-300 text-sm" value={searchTerm} onChange={handleSearchChange}/>
                                <Search className="absolute right-3 top-2.5 text-slate-400" size={16}/>
                                {searchResults.length > 0 && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 max-h-60 overflow-y-auto">
                                        {searchResults.map(p => (
                                            <div key={p.id} onClick={()=>{goToProductDetail(p); setSearchTerm(''); setSearchResults([])}} className="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0">
                                                <div className="w-8 h-8 flex-shrink-0"><img src={p.image} className="w-full h-full object-contain"/></div>
                                                <div className="min-w-0"><div className="font-bold text-xs text-slate-900 truncate">{p.name}</div></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* Mobile Menu Drawer */}
                    {isMenuOpen && (
                        <div className="fixed inset-0 z-[60] flex md:hidden">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>
                            <div className="relative w-4/5 max-w-xs bg-white h-full shadow-2xl flex flex-col mobile-menu-enter-active">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <span className="font-bold text-lg text-slate-800">Menú</span>
                                    <button onClick={() => setIsMenuOpen(false)} className="p-2 bg-white rounded-full shadow-sm"><X size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    <button onClick={() => { goHome(); setIsMenuOpen(false); }} className="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 font-medium text-slate-700">Inicio</button>
                                    <div className="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-4">Categorías</div>
                                    {categories.map(c => (
                                        <button key={c.id} onClick={() => { goToProductList(c.name); setIsMenuOpen(false); }} className="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 text-slate-600 flex justify-between items-center group">
                                            {c.name}
                                            <ChevronRight size={16} className="text-slate-300 group-hover:text-brand-500"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="flex-1 pb-20 md:pb-0">
                        {view === 'home' && renderDynamicHome()}
                        {view === 'product-list' && renderProductList()}
                        
                        {view === 'product-detail' && selectedProduct && (
                            <ProductDetailView 
                                product={selectedProduct}
                                products={products}
                                addToCart={addToCart}
                                goHome={goHome}
                                goToProductList={goToProductList}
                                navigate={navigate}
                                onProductClick={onProductClick}
                            />
                        )}

                        {view === 'cart' && renderCart()}
                        {view === 'checkout-shipping' && renderCheckoutShipping()}
                        {view === 'checkout-payment' && renderCheckoutPayment()}
                        {view === 'success' && renderSuccess()}
                        {view === 'categories' && renderCategoriesView()}
                    </main>
                    <footer className="bg-slate-900 text-slate-400 py-8 md:py-12 mt-auto">
                        <div className="container mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-8 text-sm text-center md:text-left">
                            <div><div className="flex items-center justify-center md:justify-start gap-2 text-white font-bold text-lg mb-4"><Package/> LUMEN MAYOREO</div><p>Soluciones integrales de papelería.</p></div>
                            <div className="hidden md:block">
                                <h4 className="text-white font-bold mb-4">Empresa</h4>
                                <ul className="space-y-2"><li>Nosotros</li><li>Sucursales</li></ul>
                            </div>
                            <div><h4 className="text-white font-bold mb-4">Contacto</h4><p>ventas@lumen-mayoreo.mx</p></div>
                        </div>
                        <div className="container mx-auto px-6 mt-8 pt-8 border-t border-slate-800 text-center text-xs">© 2024 Papelería Lumen Mayoreo.</div>
                    </footer>

                    {/* Bottom Nav for Mobile */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-40 px-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                        <button onClick={goHome} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === 'home' ? 'text-brand-600' : 'text-slate-400'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            <span className="text-[10px] font-medium">Inicio</span>
                        </button>
                        <button onClick={goToCategories} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === 'categories' ? 'text-brand-600' : 'text-slate-400'}`}>
                            <MenuIcon size={20}/>
                            <span className="text-[10px] font-medium">Catálogo</span>
                        </button>
                        <button onClick={()=>navigate('/carrito')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 relative ${view === 'cart' ? 'text-brand-600' : 'text-slate-400'}`}>
                            <div className="relative">
                                <ShoppingCart size={20}/>
                                {cart.length > 0 && <span className="absolute -top-1.5 -right-1.5 bg-accent-500 text-slate-900 font-bold text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full">{cart.reduce((a,c)=>a+c.quantity,0)}</span>}
                            </div>
                            <span className="text-[10px] font-medium">Carrito</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
